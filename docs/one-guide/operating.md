# 操作系统

我们可以把操作系统看成是应用程序和硬件之间插入的一层软件。操作系统有两个基本的功能：

- 防止硬件被失控的应用程序滥用。

- 向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备。

操作系统通过基本的抽象概念来实现这两个功能，包括进程、虚拟内存和文件：
![抽象](https://ws1.sinaimg.cn/large/e1b0b6d4ly1g2lqxyzrz3j20e807q41g.jpg)

## 进程

**进程**是操作系统对一个正在进行的程序的一种抽象。在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件。而**并发运行**，则是说一个进程的指令和另一个进程的指令是交错执行的。无论实在单核系统还是多核系统中，一个 CPU 看上去都像是在并发地执行多个程序，这是通过在进程间切换实现的。这种交错执行的机制就称为**上下文切换**：
![上下文切换](https://ws1.sinaimg.cn/large/e1b0b6d4ly1g2lr4zgqe7j20n50950xo.jpg)
**上下文**就是程序运行所需要的所有的状态信息，包括 PC 和 寄存器文件中的当前值，以及主存的内容。  
示例中有两个并发的进程：**shell 进程**和 **hello 进程**。最开始只有 shell 进程， 当我们让它执行 hello 进程时，shell 通过执行一个特殊的函数，叫做系统调用，将控制权传递给操作系统。操作系统会保存 shell 进程的上下文，创建一个 hello 进程及其上下文，然后将控制权交给 hello 进程。hello 程序终止后，操作系统恢复 shell 进程的上下文。

## 线程

上面的介绍基于，一个进程只有单一的控制流。但是在现代系统中，一个进程可以由多个称为线程的执行单元组成，每个线程都运行在进程的上下文中。  

## 虚拟内存

虚拟内存是一个抽象概念，它为每个进程提供一个假象，即每个进程都在独占地使用主存。每个进程看到的内存都是一致的，称为**虚拟地址空间**。linux 进程的虚拟地址空间：
![虚拟地址空间](https://ws1.sinaimg.cn/large/e1b0b6d4ly1g2lsq6bsv8j20ho0ha14k.jpg)

- **程序代码和数据**。代码和数据区是直接按照可执行目标文件的内容初始化的，在示例中就是可执行文件 hello。
  
- **堆**。代码和数据区后紧随着的是**运行时堆**。代码和数据区一开运行时就被指定了大小，堆可以在运行时动态的扩展和收缩。

- **共享库**。用来存放 C 标准库和数学库这样的共享库的代码和数据区。

- **栈**。编译器用它来实现函数用。用户栈在执行期间可以动态的扩展和收缩。每调用一个函数，栈就会增长；从一个函数返回时，栈就会收缩。

- **内核虚拟内存**。地址空间顶部的区域为内核保留。不允许应用程序读写这个区域的内容。

## 文件

文件就是字节序列，仅此而已！